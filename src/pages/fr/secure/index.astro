---
import MainLayout from '@/layouts/MainLayout.astro';
import { supabase } from '@/utils/supabase';
import translations from '@/i18n/secure.json';

// Server-side session check
let session = null;
if (import.meta.env.SSR) {
  try {
    const { data } = await supabase.auth.session();
    session = data.session;
  } catch (error) {
    console.error('SSR session check error:', error);
  }
}
---

<MainLayout title={translations.fr.secure.title}>
  <div class="auth-container max-w-sm mx-auto p-8">
    <h1 class="text-4xl lg:text-5xl font-bold text-heading dark:text-heading-dark">{translations.fr.secure.title}</h1>

    <div id="user-info" class="hidden p-8 border border-gray-200 rounded-lg bg-white dark:bg-deep-purple dark:border-gray-700">
      <p>{translations.fr.secure.welcome}, <span id="user-email" class="font-bold text-rose-flash dark:text-rose-flash"></span>!</p>
      <button class="w-full mt-4 bg-rose-flash hover:bg-rose-flash-dark text-white py-2 px-4 rounded transition-colors duration-200" id="logout-button">{translations.fr.secure.logout}</button>
    </div>

    <div id="loading" class="text-center p-8">{translations.fr.secure.loading}</div>
  </div>

  <script type="module">
    import { supabase } from '@/utils/supabase';
    
    (async () => {
      try {
        console.log('Starting session check...');
        const { data, error } = await supabase.auth.session();
        
        if (error) {
          console.error('Client-side session check error:', error);
          document.getElementById('loading').textContent = 'Authentication error: ' + error.message;
          return;
        }
        
        if (!data.session) {
          console.log('No session found, redirecting to login...');
          window.location.href = '/auth/login';
          return;
        }
        
        // Show user info
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const loading = document.getElementById('loading');
        
        if (!userInfo || !userEmail || !logoutButton || !loading) {
          console.error('DOM elements not found');
          return;
        }
        
        if (data.session?.user?.email) {
          console.log('User email:', data.session.user.email);
          userEmail.textContent = data.session.user.email;
          userInfo.classList.remove('hidden');
          loading.classList.add('hidden');
        }
        
        // Setup logout handler
        logoutButton.addEventListener('click', async () => {
          console.log('Logout button clicked');
          await supabase.auth.signOut();
          window.location.href = '/auth/login';
        });
      } catch (error) {
        console.error('Unexpected error:', error);
        document.getElementById('loading').textContent = 'Critical error: ' + error.message;
      }
    })();
  </script>
</MainLayout>
