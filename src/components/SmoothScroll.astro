---
// Lenis smooth scroll + GSAP ScrollTrigger integration
---

<script>
  import Lenis from 'lenis';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Register GSAP plugins
  gsap.registerPlugin(ScrollTrigger);

  // Initialize Lenis smooth scroll
  const lenis = new Lenis({
    duration: 1.6,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    orientation: 'vertical',
    gestureOrientation: 'vertical',
    smoothWheel: true,
    wheelMultiplier: 1,
    touchMultiplier: 2,
  });

  // Connect Lenis to GSAP ScrollTrigger
  lenis.on('scroll', ScrollTrigger.update);

  gsap.ticker.add((time) => {
    lenis.raf(time * 1000);
  });

  gsap.ticker.lagSmoothing(0);

  // Make lenis available globally for other scripts
  (window as any).lenis = lenis;

  // Scroll animations for elements with data-animate attribute
  function initScrollAnimations() {
    // Fade up animations - aggressive with rotation
    gsap.utils.toArray('[data-animate="fade-up"]').forEach((el: any) => {
      gsap.fromTo(el,
        { opacity: 0, y: 120, rotateX: 10 },
        {
          opacity: 1,
          y: 0,
          rotateX: 0,
          duration: 0.5,
          ease: 'power4.out',
          scrollTrigger: {
            trigger: el,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });

    // Fade in animations - with scale punch
    gsap.utils.toArray('[data-animate="fade-in"]').forEach((el: any) => {
      gsap.fromTo(el,
        { opacity: 0, scale: 0.9 },
        {
          opacity: 1,
          scale: 1,
          duration: 0.4,
          ease: 'back.out(1.7)',
          scrollTrigger: {
            trigger: el,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });

    // Slide left animations - dramatic entrance
    gsap.utils.toArray('[data-animate="slide-left"]').forEach((el: any) => {
      gsap.fromTo(el,
        { opacity: 0, x: 150, rotate: 3 },
        {
          opacity: 1,
          x: 0,
          rotate: 0,
          duration: 0.5,
          ease: 'power4.out',
          scrollTrigger: {
            trigger: el,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });

    // Slide right animations - dramatic entrance
    gsap.utils.toArray('[data-animate="slide-right"]').forEach((el: any) => {
      gsap.fromTo(el,
        { opacity: 0, x: -150, rotate: -3 },
        {
          opacity: 1,
          x: 0,
          rotate: 0,
          duration: 0.5,
          ease: 'power4.out',
          scrollTrigger: {
            trigger: el,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });

    // Scale up animations - explosive with bounce
    gsap.utils.toArray('[data-animate="scale-up"]').forEach((el: any) => {
      gsap.fromTo(el,
        { opacity: 0, scale: 0.5, rotate: -5 },
        {
          opacity: 1,
          scale: 1,
          rotate: 0,
          duration: 0.6,
          ease: 'back.out(2)',
          scrollTrigger: {
            trigger: el,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });

    // Stagger children animations - fast cascade
    gsap.utils.toArray('[data-animate="stagger"]').forEach((container: any) => {
      const children = container.children;
      gsap.fromTo(children,
        { opacity: 0, y: 80, scale: 0.9 },
        {
          opacity: 1,
          y: 0,
          scale: 1,
          duration: 0.4,
          stagger: 0.08,
          ease: 'power4.out',
          scrollTrigger: {
            trigger: container,
            start: 'top 90%',
            toggleActions: 'play none none reverse'
          }
        }
      );
    });
  }

  // Entrance animations for above-the-fold content (no scroll trigger)
  function initEntranceAnimations() {
    // Hero entrance - staggered reveal
    const heroElements = document.querySelectorAll('[data-entrance="hero"]');
    if (heroElements.length) {
      gsap.fromTo(heroElements,
        { opacity: 0, y: 60 },
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
          stagger: 0.15,
          ease: 'power4.out',
          delay: 0.3
        }
      );
    }

    // Hero image entrance - scale and rotate in
    const heroImage = document.querySelectorAll('[data-entrance="hero-image"]');
    if (heroImage.length) {
      gsap.fromTo(heroImage,
        { opacity: 0, scale: 0.6, rotate: -10 },
        {
          opacity: 1,
          scale: 1,
          rotate: 0,
          duration: 1,
          ease: 'back.out(1.5)',
          delay: 0.2
        }
      );
    }

    // Navbar entrance - slide down
    const navbar = document.querySelectorAll('[data-entrance="navbar"]');
    if (navbar.length) {
      gsap.fromTo(navbar,
        { opacity: 0, y: -30 },
        {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power3.out',
          delay: 0.1
        }
      );
    }

    // Generic fade entrance
    const fadeEntrance = document.querySelectorAll('[data-entrance="fade"]');
    if (fadeEntrance.length) {
      gsap.fromTo(fadeEntrance,
        { opacity: 0 },
        {
          opacity: 1,
          duration: 0.8,
          stagger: 0.1,
          ease: 'power2.out',
          delay: 0.4
        }
      );
    }

    // Circle reveal for featured images
    const circleRevealElements = document.querySelectorAll('[data-entrance="circle-reveal"]');
    if (circleRevealElements.length) {
      circleRevealElements.forEach((el: any) => {
        // Set initial clip-path
        gsap.set(el, {
          clipPath: 'circle(0% at 50% 50%)',
          opacity: 1
        });

        // Animate the circle reveal
        gsap.to(el, {
          clipPath: 'circle(150% at 50% 50%)',
          duration: 1.2,
          ease: 'power4.out',
          delay: 0.4
        });
      });
    }
  }

  // Initialize animations after DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    initEntranceAnimations();
    initScrollAnimations();
  });

  // Re-initialize on page navigation (for View Transitions)
  document.addEventListener('astro:page-load', () => {
    initEntranceAnimations();
    initScrollAnimations();
  });
</script>

<style is:global>
  /* Hide animated elements initially to prevent FOUC */
  [data-entrance="hero"],
  [data-entrance="hero-image"],
  [data-entrance="navbar"],
  [data-entrance="fade"] {
    opacity: 0;
  }

  [data-entrance="circle-reveal"] {
    clip-path: circle(0% at 50% 50%);
  }

  [data-animate="fade-up"],
  [data-animate="fade-in"],
  [data-animate="slide-left"],
  [data-animate="slide-right"],
  [data-animate="scale-up"] {
    opacity: 0;
  }

  [data-animate="stagger"] > * {
    opacity: 0;
  }

  /* Lenis smooth scroll styles */
  html.lenis, html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-smooth iframe {
    pointer-events: none;
  }
</style>
